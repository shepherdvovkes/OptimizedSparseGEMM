#!/usr/bin/env bash

# Bash script to fully reinitialize the repository and force-push to GitHub
# Uses SSH with Ed25519 key (~/.ssh/id_ed25519_work) or HTTPS with PAT
# Repository: shepherdvovkes/OptimizedSparseGEMM

# Usage:
# 1) Ensure SSH key (~/.ssh/id_ed25519_work) is added as a write-enabled deploy key OR
# 2) Export GITHUB_TOKEN with a PAT (repo scope):
#    export GITHUB_TOKEN="<your_token>"

# Navigate to project root
dir=$(cd "$(dirname "$0")" && pwd)
cd "$dir"

# 1) Remove any existing Git data
echo "Cleaning up old Git data..."
[ -d .git ] && rm -rf .git

# 2) Initialize a fresh Git repository
echo "Initializing Git repository..."
git init

# 3) Configure user identity if not set
echo "Configuring Git user..."
existing_name=$(git config --get user.name)
existing_email=$(git config --get user.email)
if [ -z "$existing_name" ] || [ -z "$existing_email" ]; then
  git config user.name "shepherdvovkes"
  git config user.email "shepherdvovkes@icloud.com"
else
  echo "Using existing Git user: $existing_name <$existing_email>"
fi

# 4) Set remote URL
echo "Configuring remote origin..."
remote_url=$(git config --get remote.origin.url)
if [ -z "$remote_url" ]; then
  if [ -n "$GITHUB_TOKEN" ]; then
    remote_url="https://${GITHUB_TOKEN}@github.com/shepherdvovkes/OptimizedSparseGEMM.git"
    echo "Using HTTPS remote with token authentication"
  else
    remote_url="git@github.com:shepherdvovkes/OptimizedSparseGEMM.git"
    echo "Using SSH remote; will use key ~/.ssh/id_ed25519_work"
  fi
  git remote add origin "$remote_url"
else
  echo "Existing remote: $remote_url"
fi

# 5) Stage all files and commit
echo "Staging files and creating commit..."
git add .
git commit -m "Reinitialize repository: initial commit of project files"

# 6) Force-push to GitHub main branch
echo "Force-pushing to GitHub main branch..."

git branch -M main
if [ -n "$GITHUB_TOKEN" ]; then
  # HTTPS push with force
  git push -u origin main --force
else
  # SSH push with specific key and force
  GIT_SSH_COMMAND="ssh -i /Users/vovkes/.ssh/id_ed25519_work -o IdentitiesOnly=yes" \
    git push -u origin main --force
fi

# 7) Cleanup remote URL if PAT was used
github_clean="https://github.com/shepherdvovkes/OptimizedSparseGEMM.git"
if [[ "$remote_url" == https://*${GITHUB_TOKEN}@* ]]; then
  git remote set-url origin "$github_clean"
fi

echo "Done: Repository reinitialized and force-pushed to $remote_url"
